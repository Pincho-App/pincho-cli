# GitLab CI configuration for Pincho CLI
# Triggers:
#   - Push to any branch: Runs tests, quality checks, and build verification
#   - Push tag v*.*.*: Runs full release pipeline with GoReleaser

stages:
  - lint
  - test
  - build
  - release
  - notify

variables:
  GOPROXY: "https://proxy.golang.org,direct"

# Cache Go modules across jobs
.go-cache: &go-cache
  cache:
    key: go-modules-$CI_COMMIT_REF_SLUG
    paths:
      - .go/pkg/mod/
    policy: pull-push

# Default Go image
default:
  image: golang:1.23

# =============================================================================
# LINT STAGE
# =============================================================================

lint:format:
  stage: lint
  <<: *go-cache
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
  script:
    - echo "=== Checking code formatting ==="
    - UNFORMATTED=$(gofmt -l .)
    - |
      if [ -n "$UNFORMATTED" ]; then
        echo "❌ The following files are not formatted:"
        echo "$UNFORMATTED"
        echo ""
        echo "Run 'gofmt -w .' to fix formatting"
        exit 1
      fi
    - echo "✓ All files are properly formatted"

lint:vet:
  stage: lint
  <<: *go-cache
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
  script:
    - echo "=== Downloading dependencies ==="
    - go mod download
    - echo "=== Running static analysis (go vet) ==="
    - go vet ./...
    - echo "✓ Static analysis passed"

lint:verify:
  stage: lint
  <<: *go-cache
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
  script:
    - echo "=== Verifying Go dependencies ==="
    - go mod download
    - go mod verify
    - echo "✓ Dependencies verified"

# =============================================================================
# TEST STAGE
# =============================================================================

test:
  stage: test
  <<: *go-cache
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
  script:
    - echo "=== Downloading dependencies ==="
    - go mod download
    - echo "=== Running tests with race detector ==="
    - go test -race -coverprofile=coverage.out -covermode=atomic -v ./...
    - echo ""
    - echo "=== Checking test coverage ==="
    - go tool cover -func=coverage.out | tail -10
    - COV=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
    - echo ""
    - echo "Total coverage: ${COV}%"
    # Enforce 30% minimum coverage for overall project
    - |
      if [ $(echo "$COV < 30" | bc) -eq 1 ]; then
        echo "❌ Coverage ${COV}% is below 30% threshold"
        exit 1
      fi
    - echo "✓ Coverage meets 30% threshold"
    # Check pkg layer coverage separately (higher standard)
    - echo ""
    - echo "=== Checking pkg layer coverage ==="
    - go test -coverprofile=pkg_coverage.out ./pkg/...
    - PKG_COV=$(go tool cover -func=pkg_coverage.out | grep total | awk '{print $3}' | sed 's/%//')
    - echo "Pkg layer coverage: ${PKG_COV}%"
    - |
      if [ $(echo "$PKG_COV < 55" | bc) -eq 1 ]; then
        echo "❌ Pkg coverage ${PKG_COV}% is below 55% threshold"
        exit 1
      fi
    - echo "✓ Pkg layer coverage meets 55% threshold"
  coverage: '/Total coverage: (\d+\.?\d*)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.out
    paths:
      - coverage.out
    expire_in: 7 days

# =============================================================================
# BUILD STAGE
# =============================================================================

build:
  stage: build
  <<: *go-cache
  variables:
    GOPATH: $CI_PROJECT_DIR/.go
  script:
    - echo "=== Downloading dependencies ==="
    - go mod download
    - echo "=== Verifying builds for all platforms ==="
    - echo "Building linux/amd64..."
    - GOOS=linux GOARCH=amd64 go build -o /dev/null .
    - echo "✓ linux/amd64"
    - echo "Building linux/arm64..."
    - GOOS=linux GOARCH=arm64 go build -o /dev/null .
    - echo "✓ linux/arm64"
    - echo "Building linux/arm (v7)..."
    - GOOS=linux GOARCH=arm GOARM=7 go build -o /dev/null .
    - echo "✓ linux/arm"
    - echo "Building darwin/amd64..."
    - GOOS=darwin GOARCH=amd64 go build -o /dev/null .
    - echo "✓ darwin/amd64"
    - echo "Building darwin/arm64..."
    - GOOS=darwin GOARCH=arm64 go build -o /dev/null .
    - echo "✓ darwin/arm64"
    - echo "Building windows/amd64..."
    - GOOS=windows GOARCH=amd64 go build -o /dev/null .
    - echo "✓ windows/amd64"
    - echo "Building windows/arm64..."
    - GOOS=windows GOARCH=arm64 go build -o /dev/null .
    - echo "✓ windows/arm64"
    - echo ""
    - echo "✓ All platform builds verified"

# =============================================================================
# RELEASE STAGE (tags only)
# =============================================================================

release:
  stage: release
  image: goreleaser/goreleaser:v2.5.1
  variables:
    GIT_DEPTH: 0  # Fetch all history for GoReleaser
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/
  script:
    - echo "=== Git tag detected: $CI_COMMIT_TAG ==="
    - echo "✓ Tag format valid"
    - echo ""
    - echo "=== Verifying required files ==="
    - test -f go.mod && echo "✓ go.mod exists" || (echo "❌ go.mod missing" && exit 1)
    - test -f go.sum && echo "✓ go.sum exists" || (echo "❌ go.sum missing" && exit 1)
    - test -f README.md && echo "✓ README.md exists" || (echo "❌ README.md missing" && exit 1)
    - test -f LICENSE && echo "✓ LICENSE exists" || (echo "❌ LICENSE missing" && exit 1)
    - test -f CHANGELOG.md && echo "✓ CHANGELOG.md exists" || (echo "❌ CHANGELOG.md missing" && exit 1)
    - test -f .goreleaser.yml && echo "✓ .goreleaser.yml exists" || (echo "❌ .goreleaser.yml missing" && exit 1)
    - echo ""
    - echo "=== Running GoReleaser ==="
    - goreleaser release --clean
    - echo ""
    - echo "✓ Release $CI_COMMIT_TAG published successfully to GitLab"

# =============================================================================
# NOTIFY STAGE (tags only)
# =============================================================================

notify:
  stage: notify
  image: curlimages/curl:latest
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/
  script:
    - echo "=== Sending release notification via NotifAI ==="
    - |
      curl -s -X POST https://api.pincho.app/notifai \
        -H "Authorization: Bearer $PINCHO_TOKEN" \
        -H "Content-Type: application/json" \
        -d "{
          \"text\": \"Pincho CLI $CI_COMMIT_TAG released successfully to GitLab. 7 platform binaries available for download. Install via curl -sSL install script or download from https://gitlab.com/pincho-app/pincho-cli/-/releases/$CI_COMMIT_TAG\",
          \"type\": \"release\"
        }"
    - echo ""
    - echo "✓ Release notification sent via NotifAI"
