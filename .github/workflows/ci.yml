# GitHub Actions CI/CD for Pincho CLI
# Triggers:
#   - Push to main: Runs lint, test, and build
#   - Pull request to main: Runs lint, test, and build
#   - Push tag v*: Runs lint, test, build, release, and notify

name: CI

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

env:
  GO_VERSION: "1.23"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Check formatting
        run: |
          UNFORMATTED=$(gofmt -l main.go cmd/ pkg/)
          if [ -n "$UNFORMATTED" ]; then
            echo "The following files are not formatted:"
            echo "$UNFORMATTED"
            echo "Run 'gofmt -w .' to fix formatting"
            exit 1
          fi
          echo "All files are properly formatted"

      - name: Run go vet
        run: go vet ./...

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run tests with race detector
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Check coverage threshold
        run: |
          COV=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${COV}%"
          if [ "$(echo "$COV < 30" | bc)" -eq 1 ]; then
            echo "Coverage ${COV}% is below 30% threshold"
            exit 1
          fi
          echo "Coverage meets 30% threshold"

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build
        run: go build -o pincho .

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [lint, test, build]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [release]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Send release notification via NotifAI
        run: |
          curl -s -X POST https://api.pincho.app/notifai \
            -H "Authorization: Bearer ${{ secrets.PINCHO_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"text\": \"Pincho CLI ${{ github.ref_name }} released successfully to GitHub. 7 platform binaries available for download.\", \"type\": \"release\"}"
          echo "Release notification sent via NotifAI"
